<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>簡易柱状図付きボーリングマップ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                sans-serif;
            overscroll-behavior-y: none;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        #main-container {
            height: calc(100vh - 56px);
        }

        .sidebar-transition {
            transition: all 0.3s ease-in-out;
        }

        .sidebar-hidden-desktop {
            transform: translateX(-100%);
            width: 0 !important;
            min-width: 0 !important;
            margin: 0 !important;
            border: none !important;
        }

        @media (max-width: 767px) {
            #listSidebar {
                height: 45%;
            }

            .sidebar-hidden-mobile {
                height: 40px !important;
            }

            .sidebar-hidden-mobile #sidebar-scroll-content {
                display: none;
            }
        }

        .layer-chart-wrapper {
            margin-bottom: 8px;
        }

        .layer-chart-container {
            display: flex;
            width: 100%;
            height: 24px;
            overflow: hidden;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .layer-segment {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 1px solid rgba(0, 0, 0, 0.3);
            box-sizing: border-box;
            transition: width 0.3s;
        }

        .depth-scale-container {
            position: relative;
            width: 100%;
            height: 16px;
            margin-top: 2px;
            font-size: 9px;
            color: #6b7280;
            overflow: hidden;
        }

        .scale-mark {
            position: absolute;
            top: 0;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
        }

        .scale-line {
            width: 1px;
            height: 4px;
            background-color: #9ca3af;
            margin-bottom: 0px;
        }

        .scale-text {
            line-height: 1;
            white-space: nowrap;
        }

        .soil-Sand {
            background-color: #fcd34d;
        }

        .soil-Clay {
            background-color: #8b5cf6;
        }

        .soil-Gravel {
            background-color: #9ca3af;
        }

        .soil-Rock {
            background-color: #4b5563;
        }

        .soil-Organic {
            background-color: #10b981;
        }

        .n-value-text {
            color: white;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.8),
                0 0 4px rgba(0, 0, 0, 0.5);
            font-size: 11px;
            font-weight: bold;
            line-height: 1;
            white-space: nowrap;
        }

        .leaflet-tooltip.leaflet-tooltip-top {
            background-color: #fff;
            border: 1px solid #d1d5db;
            padding: 2px 5px;
            border-radius: 4px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-size: 10px;
            font-weight: 600;
            opacity: 0.9;
            white-space: nowrap;
        }

        .leaflet-tooltip-top:before {
            border-top-color: transparent !important;
        }

        .leaflet-popup-content {
            min-width: 250px !important;
            margin: 14px !important;
        }

        .pdf-button {
            display: block;
            text-align: center;
            border: 1px solid #3b82f6;
            color: #3b82f6;
            background-color: white;
            margin-top: 12px;
            padding: 6px 0;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
            text-decoration: none !important;
            font-weight: 600;
        }

        .pdf-button:hover {
            background-color: #3b82f6;
            color: white;
        }

        .mobile-handle-bar {
            width: 40px;
            height: 4px;
            background-color: #d1d5db;
            border-radius: 2px;
            margin: 0 auto 4px;
        }
    </style>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">
    <header class="bg-white shadow-sm z-20 px-4 py-2 flex flex-wrap justify-between items-center flex-none">
        <div class="flex items-center space-x-4">
            <div>
                <h1 class="text-base md:text-lg font-bold text-gray-800 leading-tight">
                    ボーリングマップ「GeoVision Hiroshima」
                </h1>
            </div>
            <div class="flex items-center bg-gray-100 rounded-lg px-2 py-1 border border-gray-200">
                <input type="text" id="addressInput" placeholder="住所で検索..."
                    class="bg-transparent text-sm focus:outline-none w-32 md:w-48 px-1" />
                <button onclick="searchAddress()"
                    class="bg-blue-500 text-white p-1 rounded hover:bg-blue-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="text-right">
            <span class="text-[10px] text-gray-500">表示範囲内</span>
            <span id="visibleCount" class="text-lg md:text-xl font-bold text-blue-600">0</span>
            <span class="text-[10px] text-gray-500">/ <span id="totalCount">0</span>件</span>
        </div>
    </header>

    <main id="main-container" class="flex-grow flex flex-col md:flex-row overflow-hidden relative">
        <div id="listSidebar"
            class="sidebar-transition w-full md:h-full md:w-1/3 lg:w-1/4 bg-white border-t md:border-t-0 md:border-r border-gray-200 order-2 md:order-1 flex flex-col z-[1001] relative">
            <button onclick="toggleSidebar()"
                class="hidden md:flex absolute -right-6 top-1/2 -translate-y-1/2 bg-white border border-gray-300 rounded-r-md p-1 shadow-md hover:bg-gray-50 z-30">
                <svg id="arrowIconDesktop" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke-width="2.5" stroke="currentColor" class="w-4 h-4 text-gray-600 transition-transform">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                </svg>
            </button>

            <button onclick="toggleSidebar()"
                class="md:hidden absolute left-0 right-0 -top-10 bg-white border-t border-l border-r border-gray-200 rounded-t-xl px-6 pt-2 pb-1 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-30 flex flex-col items-center">
                <div class="mobile-handle-bar"></div>
                <div class="flex items-center gap-1">
                    <svg id="arrowIconMobile" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="2.5" stroke="currentColor"
                        class="w-3 h-3 text-gray-500 transition-transform rotate-90">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                    <span id="toggleText" class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Close
                        List</span>
                </div>
            </button>

            <div id="sidebar-scroll-content" class="flex flex-col flex-grow overflow-hidden">
                <div class="p-3 bg-gray-50 border-b border-gray-200 flex-none overflow-hidden">
                    <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">
                        エリア内のデータ一覧
                    </h2>
                    <div class="text-xs flex flex-wrap gap-x-3 gap-y-1">
                        <span class="flex items-center">
                            <div class="w-2 h-2 rounded-full soil-Sand mr-1"></div>砂質
                        </span>
                        <span class="flex items-center">
                            <div class="w-2 h-2 rounded-full soil-Clay mr-1"></div>粘性
                        </span>
                        <span class="flex items-center">
                            <div class="w-2 h-2 rounded-full soil-Gravel mr-1"></div>礫混じり
                        </span>
                        <span class="flex items-center">
                            <div class="w-2 h-2 rounded-full soil-Rock mr-1"></div>岩盤
                        </span>
                    </div>
                </div>
                <div id="dataList" class="overflow-y-auto p-3 space-y-3 flex-grow bg-white"></div>
            </div>
        </div>

        <div class="flex-grow w-full md:h-full relative order-1 md:order-2">
            <div id="map"></div>
            <div id="loading"
                class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-white px-4 py-2 rounded-full shadow-lg z-[1000] hidden">
                <span class="text-xs font-bold text-gray-600 flex items-center">
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-blue-500" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    検索中...
                </span>
            </div>
        </div>
    </main>

    <script>
        // --- 住所検索 ---
        async function searchAddress() {
            const input = document.getElementById("addressInput").value;
            if (!input) return;
            const loading = document.getElementById("loading");
            loading.classList.remove("hidden");
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                        input
                    )}`
                );
                const data = await response.json();
                if (data && data.length > 0) {
                    const result = data[0];
                    map.flyTo([result.lat, result.lon], 15, { duration: 1.5 });
                } else {
                    alert("住所が見つかりませんでした。");
                }
            } catch (error) {
                console.error("検索エラー:", error);
                alert("検索中にエラーが発生しました。");
            } finally {
                loading.classList.add("hidden");
            }
        }

        document
            .getElementById("addressInput")
            .addEventListener("keypress", (e) => {
                if (e.key === "Enter") searchAddress();
            });

        // --- サイドバー切替 ---
        let sidebarVisible = true;
        function toggleSidebar() {
            const sidebar = document.getElementById("listSidebar");
            const toggleText = document.getElementById("toggleText");
            const isMobile = window.innerWidth < 768;
            sidebarVisible = !sidebarVisible;

            if (isMobile) {
                sidebar.classList.toggle("sidebar-hidden-mobile", !sidebarVisible);
                document.getElementById("arrowIconMobile").style.transform =
                    sidebarVisible ? "rotate(90deg)" : "rotate(-90deg)";
                toggleText.textContent = sidebarVisible ? "Close List" : "Open List";
            } else {
                sidebar.classList.toggle("sidebar-hidden-desktop", !sidebarVisible);
                document.getElementById("arrowIconDesktop").style.transform =
                    sidebarVisible ? "" : "rotate(180deg)";
            }
            setTimeout(() => {
                map.invalidateSize({ animate: true });
            }, 300);
        }

        // --- データ表示ロジック ---
        let map;
        let markersLayer;
        let allData = [];
        let updateTimer = null;
        const markersByUid = new Map();

        const soilNamesJp = {
            Sand: "砂質土",
            Clay: "粘性土",
            Gravel: "礫混じり土",
            Rock: "岩盤",
            Organic: "腐植土",
        };

        function getDepthStep(maxDepth) {
            if (maxDepth <= 10) return 1;
            if (maxDepth <= 30) return 2;
            return 5;
        }

        // 深度目盛り + 水位以深の青塗り
        function buildScaleHtml(totalDepth, gwDepth) {
            const maxDepth = totalDepth || 0;
            if (maxDepth <= 0) return "";
            const step = getDepthStep(maxDepth);

            let scaleHtml = "";

            // ベース：白背景
            scaleHtml += `
        <div style="
          position:absolute;
          left:0;
          right:0;
          top:0;
          bottom:0;
          background-color:#ffffff;
          border-radius:2px;
        "></div>
      `;

            // 孔内水位以深（右側）だけ薄い青で塗る
            if (gwDepth != null && gwDepth >= 0 && gwDepth <= maxDepth) {
                const pos = (gwDepth / maxDepth) * 100; // 0〜100%
                scaleHtml += `
          <div style="
            position:absolute;
            left:${pos.toFixed(1)}%;
            right:0;
            top:0;
            bottom:0;
            background:linear-gradient(to right, rgba(59,130,246,0.18), rgba(59,130,246,0.28));
            border-radius:0 2px 2px 0;
            z-index:1;
            pointer-events:none;
          " title="この位置から右側が水位以深（${gwDepth.toFixed(2)}m）です"></div>
        `;
            }

            // 目盛り
            scaleHtml += `
        <div class="scale-mark" style="left: 0%">
          <span class="scale-line"></span>
          <span class="scale-text">0</span>
        </div>
      `;
            for (let d = step; d <= maxDepth + 0.001; d += step) {
                const left = (d / maxDepth) * 100;
                scaleHtml += `
          <div class="scale-mark" style="left: ${left.toFixed(1)}%">
            <span class="scale-line"></span>
            <span class="scale-text">${d}</span>
          </div>
        `;
            }

            return scaleHtml;
        }

        function createLayerChartHtml(layers, totalDepth, gwDepth) {
            let segmentsHtml = "";
            const maxDepth =
                totalDepth || (layers?.length ? layers[layers.length - 1].endDepth : 0);

            layers.forEach((layer) => {
                const baseThickness =
                    layer.thickness ?? layer.endDepth - layer.startDepth;
                const ratio = maxDepth > 0 ? baseThickness / maxDepth : 0;
                const displayRatio =
                    layer.displayRatioAdjusted != null
                        ? layer.displayRatioAdjusted
                        : ratio;
                const percentage = displayRatio * 100;

                const nText = layer.nIsRefusal
                    ? "50+"
                    : layer.nValue != null
                        ? layer.nValue
                        : "";
                segmentsHtml += `
          <div class="layer-segment soil-${layer.type}"
               style="width: ${percentage.toFixed(1)}%;"
               title="${layer.rawName || soilNamesJp[layer.type] || ""} N値:${nText}">
            ${percentage > 5 && nText !== ""
                        ? `<span class="n-value-text">${nText}</span>`
                        : ""
                    }
          </div>`;
            });

            const scaleHtml = buildScaleHtml(maxDepth, gwDepth);

            return `
        <div class="layer-chart-wrapper">
          <div class="layer-chart-container">
            ${segmentsHtml}
          </div>
          <div class="depth-scale-container">
            ${scaleHtml}
          </div>
        </div>`;
        }

        // XMLファイル名 -> PDFファイル名
        function xmlToPdfName(xmlFileName) {
            if (!xmlFileName) return null;
            return xmlFileName
                .replace("boring_exchange_data", "boring_geological_column")
                .replace(/\.xml$/i, ".pdf");
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const loading = document.getElementById("loading");
            loading.classList.remove("hidden");
            try {
                const res = await fetch("data.json");
                if (!res.ok) throw new Error("data.json 読込失敗");
                const json = await res.json();
                allData = Array.isArray(json) ? json : [];
                document.getElementById("totalCount").textContent = allData.length;
                initMap();
            } catch (e) {
                console.error(e);
                alert("地盤データの読み込みに失敗しました。");
            } finally {
                loading.classList.add("hidden");
            }
        });

        function initMap() {
            map = L.map("map", {
                center: [34.396, 132.459],
                zoom: 10,
                zoomControl: false,
            });
            L.control.zoom({ position: "bottomright" }).addTo(map);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "&copy; OpenStreetMap",
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            updateVisibleData();
            map.on("moveend", updateVisibleData);
            map.on("zoomend", updateMarkerTooltipVisibility);
        }

        function renderMarkers(data) {
            markersLayer.clearLayers();
            markersByUid.clear();

            data.forEach((p) => {
                const marker = L.marker([p.lat, p.lng]);
                const uid = p.uid ?? p.xmlFileName ?? p.id;
                marker.dataUid = uid;
                markersByUid.set(uid, marker);

                marker.bindTooltip(p.id, {
                    direction: "top",
                    offset: L.point(0, -15),
                });

                const layerDetails = (p.layers || [])
                    .map((l) => {
                        const nText = l.nIsRefusal
                            ? "50+"
                            : l.nValue != null
                                ? l.nValue
                                : "";
                        return `<li class="flex justify-between items-center py-0.5 border-b border-gray-100">
              <span class="text-xs font-medium">
                <span class="w-2 h-2 inline-block rounded-full soil-${l.type} mr-1"></span>
                ${l.rawName || soilNamesJp[l.type] || ""}
              </span>
              <span class="text-xs text-gray-500">
                ${l.startDepth.toFixed(2)}m〜${l.endDepth.toFixed(2)}m
              </span>
              <span class="text-xs font-bold text-gray-800">
                ${nText ? `N=${nText}` : ""}
              </span>
            </li>`;
                    })
                    .join("");

                const gwLine =
                    p.groundwater && p.groundwater.representative != null
                        ? `<p class="text-xs text-blue-700 mb-1">代表孔内水位: ${p.groundwater.representative.toFixed(
                            2
                        )}m</p>`
                        : "";

                const pdfFile = p.xmlFileName ? xmlToPdfName(p.xmlFileName) : null;
                const pdfLink = pdfFile
                    ? `<a href="pdf/${pdfFile}" target="_blank" rel="noopener noreferrer" class="pdf-button">
               柱状図PDFを開く (新しいタブ)
             </a>`
                    : `<div class="mt-2 text-xs text-gray-400">対応するPDFが見つかりません</div>`;

                marker.bindPopup(`
          <div class="min-w-[250px] text-xs">
            <div class="font-bold text-blue-700 text-sm">${p.id}</div>
            <p class="text-xs text-gray-600 mb-1">採取日: ${p.date || "-"
                    } / 総深度: ${p.depth.toFixed(2)}m</p>
            ${gwLine}
            <p class="text-gray-500 mb-2">${p.description || ""}</p>
            ${createLayerChartHtml(
                        p.layers || [],
                        p.depth,
                        p.groundwater?.representative
                    )}
            <div class="mt-2 text-gray-700 font-bold mb-1">層構成詳細</div>
            <ul class="list-none p-0 bg-gray-50 rounded p-2">${layerDetails}</ul>
            ${pdfLink}
          </div>
        `);

                markersLayer.addLayer(marker);
            });

            updateMarkerTooltipVisibility();
        }

        function renderList(data) {
            const listContainer = document.getElementById("dataList");
            if (data.length === 0) {
                listContainer.innerHTML =
                    '<div class="text-center py-10 text-gray-400">範囲内にデータなし</div>';
                return;
            }
            let html = "";
            data.slice(0, 50).forEach((point) => {
                const mainDesc = point.description
                    ? point.description.split("/")[1]?.trim() || point.description
                    : "";
                const uid = point.uid ?? point.xmlFileName ?? point.id;
                html += `
          <div onclick="focusMarker('${uid}', ${point.lat}, ${point.lng
                    })"
               class="cursor-pointer bg-white border border-gray-200 p-3 rounded-lg shadow-sm hover:border-blue-400 transition group">
            ${createLayerChartHtml(
                        point.layers || [],
                        point.depth,
                        point.groundwater?.representative
                    )}
            <div class="flex justify-between items-center mb-1">
              <span class="font-bold text-sm text-gray-800 group-hover:text-blue-700">${point.id}</span>
              <span class="text-xs text-gray-500">採取日: ${point.date || "-"
                    }</span>
            </div>
            <p class="text-xs text-gray-600">
              総深度: ${point.depth.toFixed(2)}m / ${mainDesc}
            </p>
          </div>`;
            });
            listContainer.innerHTML = html;
        }

        function updateVisibleData() {
            const loading = document.getElementById("loading");

            if (updateTimer !== null) {
                clearTimeout(updateTimer);
            }
            loading.classList.remove("hidden");

            updateTimer = setTimeout(() => {
                updateTimer = null;

                const bounds = map.getBounds();
                const center = map.getCenter();
                const visibleData = allData.filter((p) =>
                    bounds.contains(L.latLng(p.lat, p.lng))
                );

                visibleData.sort((a, b) => {
                    const da = center.distanceTo(L.latLng(a.lat, a.lng));
                    const db = center.distanceTo(L.latLng(b.lat, b.lng));
                    return da - db;
                });

                renderMarkers(visibleData);
                renderList(visibleData);
                document.getElementById("visibleCount").textContent =
                    visibleData.length;
                loading.classList.add("hidden");
            }, 200);
        }

        window.focusMarker = function (uid, lat, lng) {
            const marker = markersByUid.get(uid);

            map.flyTo([lat, lng], 15, { duration: 0.8 });

            if (!marker) return;

            setTimeout(() => {
                marker.openPopup();
            }, 900); // flyTo 完了後にポップアップ [web:122]
        };

        function updateMarkerTooltipVisibility() {
            const show = map.getZoom() >= 14;
            markersLayer.eachLayer((layer) =>
                show ? layer.openTooltip() : layer.closeTooltip()
            );
        }
    </script>
</body>

</html>